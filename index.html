<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Atelier Wil - Test Complet</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --accent: #d4af37; --dark: #0a0a0a; --green: #2ecc71; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--dark); color: white; margin: 0; text-align: center; overflow: hidden; }
        .step { display: none; min-height: 100vh; padding: 20px; box-sizing: border-box; width: 100vw; }
        .active { display: flex; flex-direction: column; justify-content: center; align-items: center; }
        input, textarea { width: 90%; max-width: 400px; padding: 18px; margin: 10px; border-radius: 12px; border: 1px solid #444; background: #1a1a1a; color: white; font-size: 18px; }
        .btn { padding: 20px 40px; background: var(--accent); color: black; border: none; border-radius: 50px; font-weight: bold; font-size: 20px; cursor: pointer; margin-top: 20px; }
        .valeur { font-size: 110px; font-weight: bold; color: var(--accent); margin: 15px 0; }
        .status-pill { padding: 12px 25px; border-radius: 30px; background: #222; font-size: 16px; margin-top: 15px; border: 1px solid #444; }
        .listening { background: var(--green); color: black; box-shadow: 0 0 20px var(--green); }
        video { width: 320px; height: 480px; background: #000; border: 2px solid var(--accent); border-radius: 10px; }
    </style>
</head>
<body>

    <section id="step1" class="step active">
        <h1 style="color:var(--accent)">ATELIER WIL</h1>
        <input type="text" id="client-prenom" placeholder="Prénom">
        <input type="text" id="client-nom" placeholder="Nom">
        <input type="tel" id="client-tel" placeholder="Téléphone">
        <input type="number" id="client-stature" placeholder="Stature (cm)">
        <button class="btn" onclick="nextStep(2)">LANCER LES MESURES</button>
    </section>

    <section id="step2" class="step">
        <div id="progress" style="color: var(--accent); font-weight: bold;">1 / 30</div>
        <h2 id="label" style="height: 60px; font-size: 24px;">--</h2>
        <div id="display" class="valeur">--</div>
        <div id="status" class="status-pill">MICRO DÉSACTIVÉ</div>
        <button id="btn-vocal" class="btn" onclick="demarrerSession()">ACTIVER LE MICRO</button>
    </section>

    <section id="step3" class="step">
        <h2 style="color:var(--accent)">OBSERVATIONS</h2>
        <textarea id="client-notes" rows="8" placeholder="Notes morphologiques..."></textarea>
        <button class="btn" onclick="nextStep(4)">PHOTOS</button>
    </section>

    <section id="step4" class="step">
        <h2 id="photo-title" style="color:var(--accent)">VUE DE FACE</h2>
        <video id="video" autoplay playsinline></video>
        <button class="btn" onclick="prochainePhoto()">CAPTURER</button>
    </section>

    <section id="step5" class="step">
        <h2 style="color:var(--accent)">DOSSIER COMPLET</h2>
        <button class="btn" onclick="genererPDF()">TÉLÉCHARGER LE PDF</button>
    </section>

<script>
    // Liste EXACTE (sans la Stature qui est en étape 1)
    const mesuresNoms = [
        "Tour de poitrine", "Tour de taille", "Tour de hanches", "Tour de bassin", 
        "Hauteur de poitrine", "Longueur devant", "Largeur devant", "Écartement de poitrine", 
        "Encolure", "Longueur d'épaule", "Tour de bras", "Tour de coude", "Tour de poignet", 
        "Longueur de bras au coude", "Longueur de bras total", "Largeur dos", "Longueur dos", 
        "Hauteur sous bras", "Hauteur taille-hanches", "Hauteur taille-bassin", "Tour de cuisse", 
        "Tour de genou", "Tour de mollet", "Tour de cheville", "Hauteur taille-genou", 
        "Hauteur taille-sol", "Hauteur entrejambe-sol", "Montante", "Longueur côté", "Hauteur genou-sol"
    ];

    let valeursMesures = [];
    let currentIdx = 0;
    let recognition = null;
    let attendConfirm = false;
    let tempVal = "";
    let sessionActive = false;

    function nextStep(n) {
        sessionActive = false;
        if(recognition) { try { recognition.stop(); } catch(e) {} }
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.getElementById('step' + n).classList.add('active');
        if(n === 4) { navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(s => document.getElementById('video').srcObject = s); }
    }

    function parler(texte, rappel) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(texte);
        u.lang = 'fr-FR';
        u.onend = () => { if(rappel && sessionActive) rappel(); };
        window.speechSynthesis.speak(u);
    }

    function demarrerSession() {
        sessionActive = true;
        document.getElementById('btn-vocal').style.display = 'none';
        annoncerMesure();
    }

    function ecouter() {
        if(!sessionActive) return;
        
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(recognition) { recognition.onresult = null; recognition.onend = null; try { recognition.stop(); } catch(e) {} }
        
        recognition = new Speech();
        recognition.lang = 'fr-FR';
        
        recognition.onstart = () => {
            document.getElementById('status').innerText = "À L'ÉCOUTE...";
            document.getElementById('status').classList.add('listening');
        };

        recognition.onresult = (e) => {
            const vocal = e.results[0][0].transcript.toLowerCase();
            if(attendConfirm) {
                if(vocal.includes("oui") || vocal.includes("ok") || vocal.includes("valide")) {
                    valeursMesures.push(tempVal);
                    currentIdx++;
                    if(currentIdx < mesuresNoms.length) annoncerMesure(); else nextStep(3);
                } else { annoncerMesure(); }
            } else {
                let nb = vocal.replace(/[^0-9,.]/g, '').replace(',', '.');
                if(nb) {
                    tempVal = nb;
                    attendConfirm = true;
                    document.getElementById('display').innerText = nb;
                    parler(nb + ". Valider ?", () => { ecouter(); });
                } else { ecouter(); }
            }
        };

        recognition.onend = () => {
            document.getElementById('status').innerText = "MICRO EN PAUSE";
            document.getElementById('status').classList.remove('listening');
        };

        recognition.start();
    }

    function annoncerMesure() {
        attendConfirm = false;
        document.getElementById('label').innerText = mesuresNoms[currentIdx];
        document.getElementById('display').innerText = "--";
        document.getElementById('progress').innerText = `${currentIdx + 1} / 30`;
        parler(mesuresNoms[currentIdx], () => { ecouter(); });
    }

    let photoCount = 0;
    function prochainePhoto() {
        photoCount++;
        const titres = ["FACE", "PROFIL", "DOS"];
        if(photoCount < 3) {
            document.getElementById('photo-title').innerText = "VUE DE " + titres[photoCount];
        } else { nextStep(5); }
    }

    function genererPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const p = document.getElementById('client-prenom').value;
        const n = document.getElementById('client-nom').value;
        const s = document.getElementById('client-stature').value;
        
        doc.setFontSize(18);
        doc.text(`Fiche Client : ${p} ${n}`, 20, 20);
        doc.text(`Stature : ${s} cm`, 20, 30);
        
        let y = 50;
        doc.setFontSize(12);
        mesuresNoms.forEach((m, i) => {
            doc.text(`${m} : ${valeursMesures[i] || '--'} cm`, 20, y);
            y += 7;
            if(y > 280) { doc.addPage(); y = 20; }
        });
        doc.save(`${p}_${n}.pdf`);
    }
</script>
</body>
</html>
