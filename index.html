<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Atelier Wil - Correction Micro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --accent: #d4af37; --dark: #0a0a0a; --green: #2ecc71; --red: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--dark); color: white; margin: 0; text-align: center; overflow: hidden; }
        .step { display: none; min-height: 100vh; padding: 20px; box-sizing: border-box; width: 100vw; }
        .active { display: flex; flex-direction: column; justify-content: center; align-items: center; }
        input, textarea { width: 90%; max-width: 400px; padding: 18px; margin: 10px; border-radius: 12px; border: 1px solid #444; background: #1a1a1a; color: white; font-size: 18px; }
        .btn { padding: 20px 40px; background: var(--accent); color: black; border: none; border-radius: 50px; font-weight: bold; font-size: 20px; cursor: pointer; margin-top: 20px; }
        .btn-secours { padding: 10px 20px; background: transparent; color: var(--red); border: 1px solid var(--red); border-radius: 10px; font-size: 14px; margin-top: 20px; cursor: pointer; }
        .valeur { font-size: 110px; font-weight: bold; color: var(--accent); margin: 15px 0; }
        .status-pill { padding: 12px 25px; border-radius: 30px; background: #222; font-size: 16px; margin-top: 15px; border: 1px solid #444; }
        .listening { background: var(--green); color: black; box-shadow: 0 0 20px var(--green); border-color: var(--green); }
        video { width: 320px; height: 480px; background: #000; border: 2px solid var(--accent); border-radius: 10px; }
    </style>
</head>
<body>

    <section id="step1" class="step active">
        <h1 style="color:var(--accent)">ATELIER WIL</h1>
        <input type="text" id="client-prenom" placeholder="Prénom">
        <input type="text" id="client-nom" placeholder="Nom">
        <input type="tel" id="client-tel" placeholder="Téléphone">
        <input type="number" id="client-stature" placeholder="Stature (cm)">
        <button class="btn" onclick="nextStep(2)">LANCER LES MESURES</button>
    </section>

    <section id="step2" class="step">
        <div id="progress" style="color: var(--accent); font-weight: bold;">1 / 30</div>
        <h2 id="label" style="height: 60px; font-size: 24px;">--</h2>
        <div id="display" class="valeur">--</div>
        <div id="status" class="status-pill">MICRO ARRÊTÉ</div>
        
        <button id="btn-vocal" class="btn" onclick="demarrerSession()">ACTIVER LE MICRO</button>
        
        <button id="btn-relance" class="btn-secours" style="display:none;" onclick="forcerRelance()">RELANCER LE MICRO (SÉCURITÉ)</button>
    </section>

    <section id="step3" class="step">
        <h2 style="color:var(--accent)">OBSERVATIONS</h2>
        <textarea id="client-notes" rows="8" placeholder="Notes..."></textarea>
        <button class="btn" onclick="nextStep(4)">PHOTOS</button>
    </section>

    <section id="step4" class="step">
        <h2 id="photo-title" style="color:var(--accent)">VUE DE FACE</h2>
        <video id="video" autoplay playsinline></video>
        <button class="btn" onclick="prochainePhoto()">CAPTURER</button>
    </section>

    <section id="step5" class="step">
        <h2 style="color:var(--accent)">DOSSIER COMPLET</h2>
        <button class="btn" onclick="genererPDF()">TÉLÉCHARGER LE PDF</button>
    </section>

<script>
    const mesuresNoms = [
        "Tour de poitrine", "Tour de taille", "Tour de hanches", "Tour de bassin", 
        "Hauteur de poitrine", "Longueur devant", "Largeur devant", "Écartement de poitrine", 
        "Encolure", "Longueur d'épaule", "Tour de bras", "Tour de coude", "Tour de poignet", 
        "Longueur de bras au coude", "Longueur de bras total", "Largeur dos", "Longueur dos", 
        "Hauteur sous bras", "Hauteur taille-hanches", "Hauteur taille-bassin", "Tour de cuisse", 
        "Tour de genou", "Tour de mollet", "Tour de cheville", "Hauteur taille-genou", 
        "Hauteur taille-sol", "Hauteur entrejambe-sol", "Montante", "Longueur côté", "Hauteur genou-sol"
    ];

    let valeursMesures = [];
    let currentIdx = 0;
    let recognition = null;
    let attendConfirm = false;
    let tempVal = "";
    let sessionActive = false;
    let microEnEcoute = false; // Etat réel du micro

    function nextStep(n) {
        sessionActive = false;
        stopRecognition();
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.getElementById('step' + n).classList.add('active');
        if(n === 4) startCamera();
    }

    function parler(texte, rappel) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(texte);
        u.lang = 'fr-FR';
        u.onend = () => { if(rappel && sessionActive) rappel(); };
        window.speechSynthesis.speak(u);
    }

    function demarrerSession() {
        sessionActive = true;
        document.getElementById('btn-vocal').style.display = 'none';
        document.getElementById('btn-relance').style.display = 'block';
        annoncerMesure();
        
        // BOUCLE DE SÉCURITÉ : Vérifie toutes les 1.5s si le micro est tombé
        setInterval(() => {
            if(sessionActive && !microEnEcoute && !window.speechSynthesis.speaking) {
                console.log("Relance automatique du micro...");
                ecouter();
            }
        }, 1500);
    }

    function stopRecognition() {
        if(recognition) {
            recognition.onresult = null;
            recognition.onend = null;
            try { recognition.stop(); } catch(e) {}
            recognition = null;
        }
        microEnEcoute = false;
    }

    function ecouter() {
        if(!sessionActive || window.speechSynthesis.speaking) return;
        
        stopRecognition();
        
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new Speech();
        recognition.lang = 'fr-FR';
        recognition.continuous = false;
        recognition.interimResults = false;

        recognition.onstart = () => {
            microEnEcoute = true;
            document.getElementById('status').innerText = "À L'ÉCOUTE...";
            document.getElementById('status').classList.add('listening');
        };

        recognition.onresult = (e) => {
            const vocal = e.results[0][0].transcript.toLowerCase();
            if(attendConfirm) {
                if(vocal.includes("oui") || vocal.includes("ok") || vocal.includes("valide")) {
                    valeursMesures.push(tempVal);
                    currentIdx++;
                    if(currentIdx < mesuresNoms.length) annoncerMesure(); else nextStep(3);
                } else { 
                    annoncerMesure(); 
                }
            } else {
                let nb = vocal.replace(/[^0-9,.]/g, '').replace(',', '.');
                let matches = vocal.match(/\d+([,.]\d+)?/);
                if(matches) {
                    tempVal = matches[0].replace(',', '.');
                    attendConfirm = true;
                    document.getElementById('display').innerText = tempVal;
                    parler(tempVal + ". Valider ?"); // Le rappel se fera via la boucle setInterval
                }
            }
        };

        recognition.onend = () => {
            microEnEcoute = false;
            document.getElementById('status').innerText = "EN PAUSE / ANALYSE";
            document.getElementById('status').classList.remove('listening');
        };

        try { recognition.start(); } catch(e) { microEnEcoute = false; }
    }

    function forcerRelance() {
        window.speechSynthesis.cancel();
        parler("Micro relancé");
        ecouter();
    }

    function annoncerMesure() {
        attendConfirm = false;
        document.getElementById('label').innerText = mesuresNoms[currentIdx];
        document.getElementById('display').innerText = "--";
        document.getElementById('progress').innerText = `${currentIdx + 1} / 30`;
        parler(mesuresNoms[currentIdx]);
    }

    // Caméra & Photo
    function startCamera() {
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(s => document.getElementById('video').srcObject = s);
    }

    let photoCount = 0;
    function prochainePhoto() {
        photoCount++;
        const titres = ["FACE", "PROFIL", "DOS"];
        if(photoCount < 3) {
            document.getElementById('photo-title').innerText = "VUE DE " + titres[photoCount];
        } else { nextStep(5); }
    }

    function genererPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const p = document.getElementById('client-prenom').value;
        const n = document.getElementById('client-nom').value;
        const s = document.getElementById('client-stature').value;
        doc.text(`Fiche : ${p} ${n} - Stature: ${s}cm`, 20, 20);
        let y = 40;
        mesuresNoms.forEach((m, i) => {
            doc.text(`${m} : ${valeursMesures[i] || '--'} cm`, 20, y);
            y += 8;
        });
        doc.save(`${p}_mesures.pdf`);
    }
</script>
</body>
</html>
