<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Atelier Wil - Debug</title>
    <style>
        :root { --accent: #d4af37; --dark: #0a0a0a; }
        body { font-family: sans-serif; background: var(--dark); color: white; text-align: center; margin: 0; }
        .container { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .btn-start { 
            padding: 30px 60px; 
            background: var(--accent); 
            color: black; 
            border: none; 
            border-radius: 10px; 
            font-weight: bold; 
            font-size: 24px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            touch-action: manipulation;
        }
        #ui { display: none; flex-direction: column; justify-content: center; align-items: center; height: 100vh; }
        .valeur { font-size: 100px; color: var(--accent); font-weight: bold; }
        .mesure-nom { font-size: 24px; margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="start-screen" class="container">
    <h1 style="color:var(--accent)">TEST DIAGNOSTIC</h1>
    <p id="debug-info" style="font-size: 12px; color: #666;">En attente de clic...</p>
    <button class="btn-start" id="mainButton">DÉMARRER</button>
</div>

<div id="ui">
    <div id="progress">1 / 31</div>
    <div id="label" class="mesure-nom">Chargement...</div>
    <div id="display" class="valeur">--</div>
    <div id="status">ÉCOUTE...</div>
</div>

<script>
    const mesures = ["Tour de poitrine", "Tour de taille", "Tour de hanches", "Tour de bassin", "Hauteur poitrine", "Longueur devant", "Largeur devant", "Ecartement poitrine", "Encolure", "Longueur épaule", "Tour de bras", "Tour de coude", "Tour de poignet", "Longueur bras au coude", "Longueur bras total", "Largeur dos", "Longueur dos", "Hauteur sous bras", "Hauteur taille-hanches", "Hauteur taille-bassin", "Tour de cuisse", "Tour de genou", "Tour de mollet", "Tour de cheville", "Hauteur taille-genou", "Hauteur taille-sol", "Hauteur entrejambe-sol", "Montante", "Tour de tête", "Tour de main", "Stature totale"];
    let idx = 0;
    let recognition;
    let attendConfirm = false;
    let tempVal = "";

    // On attache l'événement proprement pour Android
    document.getElementById('mainButton').addEventListener('click', function() {
        demarrer();
    });

    function parler(t, cb) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(t);
        u.lang = 'fr-FR';
        if (cb) u.onend = cb;
        window.speechSynthesis.speak(u);
    }

    function demarrer() {
        document.getElementById('debug-info').innerText = "Initialisation...";
        
        try {
            // 1. Test de la voix
            parler(""); 

            // 2. Test du Micro
            const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!Speech) {
                throw new Error("Reconnaissance vocale non supportée sur ce navigateur.");
            }

            recognition = new Speech();
            recognition.lang = 'fr-FR';
            recognition.continuous = true;

            recognition.onstart = () => {
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('ui').style.display = 'flex';
                annoncer();
            };

            recognition.onerror = (e) => {
                alert("Erreur micro : " + e.error);
                if(e.error === 'not-allowed') alert("Allez dans les paramètres de la tablette > Applications > Chrome > Autorisations > Micro.");
            };

            recognition.onresult = gererResultat;
            
            // Lancement
            recognition.start();

        } catch (err) {
            alert("ERREUR CRITIQUE : " + err.message);
            document.getElementById('debug-info').innerText = err.message;
        }
    }

    function gererResultat(e) {
        const text = e.results[e.results.length - 1][0].transcript.toLowerCase();
        if (attendConfirm) {
            if (text.includes("oui") || text.includes("ok")) valider(true);
            else if (text.includes("non")) valider(false);
        } else {
            let num = text.replace(/[^0-9,.]/g, '').replace(',', '.');
            const match = num.match(/\d+(\.\d+)?/);
            if (match) {
                tempVal = match[0];
                attendConfirm = true;
                document.getElementById('display').innerText = tempVal.replace('.', ',');
                parler(tempVal.replace('.', ',') + ". Valider ?");
            }
        }
    }

    function annoncer() {
        attendConfirm = false;
        document.getElementById('label').innerText = mesures[idx];
        document.getElementById('display').innerText = "--";
        document.getElementById('progress').innerText = `${idx + 1} / 31`;
        parler(mesures[idx]);
    }

    function valider(ok) {
        if (ok) {
            idx++;
            if (idx < mesures.length) annoncer();
            else alert("Terminé !");
        } else {
            annoncer();
        }
    }
</script>
</body>
</html>
