<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Atelier Wil - Expert</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --accent: #d4af37; --dark: #0a0a0a; --green: #2ecc71; --red: #ff4444; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--dark); color: white; margin: 0; text-align: center; overflow-x: hidden; }
        .step { display: none; min-height: 100vh; padding: 20px; box-sizing: border-box; }
        .active { display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        input, textarea { width: 90%; max-width: 400px; padding: 15px; margin: 10px; border-radius: 8px; border: 1px solid #333; background: #1a1a1a; color: white; font-size: 16px; }
        .btn { padding: 20px 40px; background: var(--accent); color: black; border: none; border-radius: 50px; font-weight: bold; font-size: 18px; cursor: pointer; margin-top: 20px; transition: 0.3s; }
        
        .valeur { font-size: 100px; font-weight: bold; color: var(--accent); margin: 10px 0; }
        .status-pill { padding: 10px 20px; border-radius: 20px; background: #222; font-size: 14px; margin-top: 10px; border: 1px solid #444; }
        .listening { background: var(--green); color: black; box-shadow: 0 0 15px var(--green); border: none; }

        #photo-container { position: relative; width: 320px; height: 480px; background: #000; border: 2px solid var(--accent); margin: 15px 0; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .guide-line { position: absolute; left: 0; width: 100%; height: 2px; background: var(--accent); cursor: ns-resize; touch-action: none; }
    </style>
</head>
<body>

    <section id="step1" class="step active">
        <h1 style="color:var(--accent); letter-spacing: 3px;">ATELIER WIL</h1>
        <input type="text" id="client-prenom" placeholder="Prénom">
        <input type="text" id="client-nom" placeholder="Nom">
        <input type="tel" id="client-tel" placeholder="Numéro de téléphone">
        <button class="btn" onclick="validerEtape1()">LANCER LES MESURES</button>
    </section>

    <section id="step2" class="step">
        <div id="progress" style="opacity:0.5">1 / 31</div>
        <h2 id="label" style="height: 60px; color: var(--accent);">Prêt</h2>
        <div id="display" class="valeur">--</div>
        <div id="status" class="status-pill">MICRO DÉSACTIVÉ</div>
        <button id="btn-vocal" class="btn" onclick="initVocal()">ACTIVER LE MICRO</button>
    </section>

    <section id="step3" class="step">
        <h2 style="color:var(--accent)">OBSERVATIONS</h2>
        <textarea id="client-notes" rows="6" placeholder="Notes de morphologie..."></textarea>
        <button class="btn" onclick="nextStep(4)">PASSER AUX PHOTOS</button>
    </section>

    <section id="step4" class="step">
        <h2 id="photo-title" style="color:var(--accent)">VUE DE FACE</h2>
        <div id="photo-container">
            <video id="video" autoplay playsinline></video>
            <div class="guide-line" style="top: 25%" onpointermove="dragLine(event)"></div>
            <div class="guide-line" style="top: 50%" onpointermove="dragLine(event)"></div>
            <div class="guide-line" style="top: 75%" onpointermove="dragLine(event)"></div>
        </div>
        <button class="btn" onclick="capturePhoto()">CAPTURER</button>
    </section>

    <section id="step5" class="step">
        <h2 style="color:var(--accent)">DOSSIER COMPLET</h2>
        <button class="btn" onclick="genererPDF()">TÉLÉCHARGER LE PDF</button>
        <button class="btn" style="background:#333; color:white;" onclick="location.reload()">NOUVEAU</button>
    </section>

<script>
    const mesuresNoms = ["Tour de poitrine", "Tour de taille", "Tour de hanches", "Tour de bassin", "Hauteur poitrine", "Longueur devant", "Largeur devant", "Ecartement poitrine", "Encolure", "Longueur épaule", "Tour de bras", "Tour de coude", "Tour de poignet", "Longueur bras au coude", "Longueur bras total", "Largeur dos", "Longueur dos", "Hauteur sous bras", "Hauteur taille-hanches", "Hauteur taille-bassin", "Tour de cuisse", "Tour de genou", "Tour de mollet", "Tour de cheville", "Hauteur taille-genou", "Hauteur taille-sol", "Hauteur entrejambe-sol", "Montante", "Longueur côté", "Hauteur genou-sol", "Stature totale"];
    let valeursMesures = [];
    let currentIdx = 0;
    let recognition;
    let attendConfirm = false;
    let tempVal = "";
    let isVocalActive = false;

    function nextStep(n) {
        isVocalActive = false;
        if(recognition) recognition.stop();
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.getElementById('step' + n).classList.add('active');
        if(n === 4) startCamera();
    }

    function validerEtape1() {
        if (!document.getElementById('client-prenom').value || !document.getElementById('client-tel').value) {
            alert("Prénom et Téléphone requis."); return;
        }
        nextStep(2);
    }

    function parler(t) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(t);
        u.lang = 'fr-FR';
        u.onstart = () => { if(recognition) recognition.abort(); };
        u.onend = () => { if(isVocalActive && recognition) try { recognition.start(); } catch(e){} };
        window.speechSynthesis.speak(u);
    }

    function initVocal() {
        isVocalActive = true;
        document.getElementById('btn-vocal').style.display = 'none';
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new Speech();
        recognition.lang = 'fr-FR';
        recognition.continuous = false;
        recognition.interimResults = false;

        recognition.onstart = () => {
            document.getElementById('status').innerText = "À VOUS...";
            document.getElementById('status').classList.add('listening');
        };

        recognition.onend = () => {
            document.getElementById('status').innerText = "PAUSE";
            document.getElementById('status').classList.remove('listening');
            // RELANCE AUTOMATIQUE SI PAS DE RESULTAT
            if(isVocalActive && !window.speechSynthesis.speaking) {
                setTimeout(() => { try { recognition.start(); } catch(e){} }, 300);
            }
        };

        recognition.onresult = (e) => {
            const result = e.results[0][0].transcript.toLowerCase();
            if (attendConfirm) {
                if (result.includes("oui") || result.includes("ok") || result.includes("valide")) {
                    valeursMesures.push(tempVal);
                    currentIdx++;
                    if (currentIdx < mesuresNoms.length) annoncer(); else nextStep(3);
                } else if (result.includes("non") || result.includes("pas")) {
                    annoncer();
                }
            } else {
                let num = result.replace(/[^0-9,.]/g, '').replace(',', '.');
                let match = num.match(/\d+(\.\d+)?/);
                if (match) {
                    tempVal = match[0];
                    attendConfirm = true;
                    document.getElementById('display').innerText = tempVal.replace('.', ',');
                    parler(tempVal.replace('.', ',') + ". Valider ?");
                }
            }
        };
        annoncer();
    }

    function annoncer() {
        attendConfirm = false;
        document.getElementById('label').innerText = mesuresNoms[currentIdx];
        document.getElementById('display').innerText = "--";
        document.getElementById('progress').innerText = `${currentIdx + 1} / 31`;
        parler(mesuresNoms[currentIdx]);
    }

    function dragLine(e) {
        if(e.buttons !== 1 && e.type !== 'pointermove') return;
        let rect = document.getElementById('photo-container').getBoundingClientRect();
        let y = ((e.clientY - rect.top) / rect.height) * 100;
        if(y >= 0 && y <= 100) e.target.style.top = y + "%";
    }

    function startCamera() {
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => { document.getElementById('video').srcObject = stream; });
    }

    function capturePhoto() {
        alert("Photo capturée");
        nextStep(5);
    }

    function genererPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const prenom = document.getElementById('client-prenom').value;
        const tel = document.getElementById('client-tel').value.replace(/\s/g, '');
        
        doc.text(`Atelier Wil - ${prenom}`, 20, 20);
        let y = 40;
        mesuresNoms.forEach((m, i) => {
            doc.text(`${m} : ${valeursMesures[i] || '--'} cm`, 20, y);
            y += 7;
            if(y > 280) { doc.addPage(); y = 20; }
        });
        doc.save(`${prenom}_${tel}.pdf`);
    }
</script>
</body>
</html>
