<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Atelier Wil - Expert</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --accent: #d4af37; --dark: #0a0a0a; --green: #2ecc71; --red: #ff4444; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--dark); color: white; margin: 0; text-align: center; }
        .step { display: none; min-height: 100vh; padding: 20px; box-sizing: border-box; }
        .active { display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        /* Formulaires */
        input, textarea { width: 80%; max-width: 400px; padding: 15px; margin: 10px; border-radius: 8px; border: 1px solid #333; background: #1a1a1a; color: white; font-size: 16px; }
        .btn { padding: 20px 40px; background: var(--accent); color: black; border: none; border-radius: 50px; font-weight: bold; font-size: 18px; cursor: pointer; margin-top: 20px; }
        
        /* Mesures */
        .valeur { font-size: 100px; font-weight: bold; color: var(--accent); margin: 20px 0; }
        .status-pill { padding: 10px 20px; border-radius: 20px; background: #222; font-size: 14px; }
        .listening { background: var(--green); color: black; }

        /* Photo & Lignes */
        #photo-container { position: relative; width: 320px; height: 480px; background: #000; overflow: hidden; border: 2px solid #333; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .guide-line { position: absolute; left: 0; width: 100%; height: 2px; background: rgba(212, 175, 55, 0.7); cursor: ns-resize; touch-action: none; }
    </style>
</head>
<body>

    <section id="step1" class="step active">
        <h1 style="color:var(--accent)">CLIENT</h1>
        <input type="text" id="client-nom" placeholder="Nom du client">
        <input type="text" id="client-prenom" placeholder="Prénom">
        <button class="btn" onclick="nextStep(2)">COMMENCER LES MESURES</button>
    </section>

    <section id="step2" class="step">
        <div id="progress" style="opacity:0.5">1 / 31</div>
        <h2 id="label" style="color:var(--accent)">Prêt</h2>
        <div id="display" class="valeur">--</div>
        <div id="status" class="status-pill">INITIALISATION</div>
        <button id="btn-vocal" class="btn" onclick="initVocal()">ACTIVER LE MICRO</button>
    </section>

    <section id="step3" class="step">
        <h2 style="color:var(--accent)">OBSERVATIONS</h2>
        <p>Remarques particulières sur la morphologie :</p>
        <textarea id="client-notes" rows="8" placeholder="Ex: Épaule droite plus basse, cambrure marquée..."></textarea>
        <button class="btn" onclick="nextStep(4)">PASSER AUX PHOTOS</button>
    </section>

    <section id="step4" class="step">
        <h2 id="photo-title" style="color:var(--accent)">VUE DE FACE</h2>
        <div id="photo-container">
            <video id="video" autoplay playsinline></video>
            <div class="guide-line" style="top: 20%" onpointermove="dragLine(event)"></div>
            <div class="guide-line" style="top: 40%" onpointermove="dragLine(event)"></div>
            <div class="guide-line" style="top: 60%" onpointermove="dragLine(event)"></div>
            <div class="guide-line" style="top: 80%" onpointermove="dragLine(event)"></div>
        </div>
        <p style="font-size:12px">Glissez les lignes jaunes au doigt</p>
        <button class="btn" onclick="capturePhoto()">PRENDRE LA PHOTO</button>
    </section>

    <section id="step5" class="step">
        <h2 style="color:var(--accent)">DOSSIER PRÊT</h2>
        <div id="resume"></div>
        <button class="btn" onclick="genererPDF()">TÉLÉCHARGER LE PDF</button>
    </section>

<script>
    const mesuresNoms = ["Tour de poitrine", "Tour de taille", "Tour de hanches", "Tour de bassin", "Hauteur poitrine", "Longueur devant", "Largeur devant", "Ecartement poitrine", "Encolure", "Longueur épaule", "Tour de bras", "Tour de coude", "Tour de poignet", "Longueur bras au coude", "Longueur bras total", "Largeur dos", "Longueur dos", "Hauteur sous bras", "Hauteur taille-hanches", "Hauteur taille-bassin", "Tour de cuisse", "Tour de genou", "Tour de mollet", "Tour de cheville", "Hauteur taille-genou", "Hauteur taille-sol", "Hauteur entrejambe-sol", "Montante", "Longueur côté", "Hauteur genou-sol", "Stature totale"];
    let valeursMesures = [];
    let currentIdx = 0;
    let recognition;
    let attendConfirm = false;
    let tempVal = "";
    let photos = [];
    let photoSteps = ["FACE", "PROFIL", "DOS"];
    let currentPhotoIdx = 0;

    function nextStep(n) {
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.getElementById('step' + n).classList.add('active');
        if(n === 4) startCamera();
    }

    // --- LOGIQUE VOCALE ---
    function initVocal() {
        document.getElementById('btn-vocal').style.display = 'none';
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new Speech();
        recognition.lang = 'fr-FR';
        recognition.onresult = (e) => {
            const result = e.results[0][0].transcript.toLowerCase();
            if (attendConfirm) {
                if (result.includes("oui") || result.includes("ok")) {
                    valeursMesures.push(tempVal);
                    currentIdx++;
                    if (currentIdx < mesuresNoms.length) annoncer();
                    else nextStep(3);
                } else if (result.includes("non")) {
                    annoncer();
                }
            } else {
                let num = result.replace(/[^0-9,.]/g, '').replace(',', '.');
                let match = num.match(/\d+(\.\d+)?/);
                if (match) {
                    tempVal = match[0];
                    attendConfirm = true;
                    document.getElementById('display').innerText = tempVal;
                    parler(tempVal + ". Valider ?");
                } else {
                    recognition.start();
                }
            }
        };
        annoncer();
    }

    function parler(t) {
        if(recognition) try { recognition.stop(); } catch(e){}
        const u = new SpeechSynthesisUtterance(t);
        u.lang = 'fr-FR';
        u.onend = () => { if(recognition) try { recognition.start(); } catch(e){} };
        window.speechSynthesis.speak(u);
    }

    function annoncer() {
        attendConfirm = false;
        document.getElementById('label').innerText = mesuresNoms[currentIdx];
        document.getElementById('display').innerText = "--";
        document.getElementById('progress').innerText = `${currentIdx + 1} / 31`;
        parler(mesuresNoms[currentIdx]);
    }

    // --- LOGIQUE PHOTO ---
    function dragLine(e) {
        if(e.buttons !== 1) return;
        let rect = document.getElementById('photo-container').getBoundingClientRect();
        let y = ((e.clientY - rect.top) / rect.height) * 100;
        e.target.style.top = y + "%";
    }

    function startCamera() {
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => { document.getElementById('video').srcObject = stream; });
    }

    function capturePhoto() {
        // Ici on simule la capture (dans une vraie app on dessine la vidéo + les lignes sur un canvas)
        photos.push("Photo " + photoSteps[currentPhotoIdx]);
        currentPhotoIdx++;
        if(currentPhotoIdx < photoSteps.length) {
            document.getElementById('photo-title').innerText = "VUE DE " + photoSteps[currentPhotoIdx];
        } else {
            nextStep(5);
        }
    }

    // --- PDF ---
    function genererPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let nom = document.getElementById('client-nom').value;
        let notes = document.getElementById('client-notes').value;
        
        doc.setFontSize(20);
        doc.text("FICHE TECHNIQUE - ATELIER WIL", 20, 20);
        doc.setFontSize(12);
        doc.text(`Client : ${nom}`, 20, 35);
        doc.text(`Notes : ${notes}`, 20, 45);
        
        let y = 60;
        mesuresNoms.forEach((m, i) => {
            doc.text(`${m} : ${valeursMesures[i] || '--'} cm`, 20, y);
            y += 7;
            if(y > 280) { doc.addPage(); y = 20; }
        });
        
        doc.save(`Atelier_Wil_${nom}.pdf`);
    }
</script>
</body>
</html>
