<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atelier Wil - Mains Libres</title>
    <style>
        :root { --accent: #d4af37; --dark: #0a0a0a; --green: #2ecc71; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--dark); color: white; text-align: center; margin: 0; overflow: hidden; }
        .container { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .mesure-nom { font-size: 28px; color: var(--accent); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; }
        .valeur { font-size: 120px; font-weight: bold; color: white; margin: 20px 0; }
        .status-bar { position: fixed; bottom: 0; width: 100%; padding: 20px; background: #111; border-top: 2px solid #222; }
        .indicator { width: 20px; height: 20px; border-radius: 50%; display: inline-block; margin-right: 10px; background: #444; }
        .recording { background: var(--green); box-shadow: 0 0 15px var(--green); }
        .instruction { font-style: italic; color: #888; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div id="next-label" style="color: #555; font-size: 14px;">PRÊT</div>
    <div class="mesure-nom" id="label">Chargement...</div>
    <div class="valeur" id="display">--</div>
    <div class="instruction" id="hint">Dites un chiffre pour commencer</div>
    
    <button onclick="startListening()" id="start-btn" style="padding: 15px 30px; background: var(--accent); border: none; border-radius: 50px; font-weight: bold; cursor: pointer;">ACTIVER LE MODE MAINS LIBRES</button>
</div>

<div class="status-bar">
    <span id="led" class="indicator"></span>
    <span id="state">Micro désactivé</span>
</div>

<script>
    const mesures = ["Poitrine", "Taille", "Hanches", "Bassin", "Long. Devant", "Carrure Devant", "Encolure", "Carrure Dos", "Long. Dos", "Bras", "Poignet"];
    let idx = 0;
    const results = {};
    
    const label = document.getElementById('label');
    const display = document.getElementById('display');
    const led = document.getElementById('led');
    const state = document.getElementById('state');
    const startBtn = document.getElementById('start-btn');

    const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new Speech();
    
    // CONFIGURATION CRUCIALE POUR REDMI/CHROME
    recognition.lang = 'fr-FR';
    recognition.continuous = true; // Reste allumé en permanence
    recognition.interimResults = false; // N'attend que la version finale

    function startListening() {
        try {
            recognition.start();
            startBtn.style.display = 'none';
            label.innerText = mesures[idx];
        } catch(e) { console.log("Déjà lancé"); }
    }

    recognition.onstart = () => {
        led.classList.add('recording');
        state.innerText = "JE VOUS ÉCOUTE...";
    };

    recognition.onresult = (event) => {
        const last = event.results.length - 1;
        const text = event.results[last][0].transcript.toLowerCase();
        
        // Extraction du nombre
        const match = text.match(/\d+/);
        
        if (match) {
            const val = match[0];
            display.innerText = val;
            results[mesures[idx]] = val;
            
            // Feedback visuel rapide
            display.style.color = "#2ecc71";
            
            // Synthèse vocale pour confirmer sans regarder
            const msg = new SpeechSynthesisUtterance(val);
            msg.lang = 'fr-FR';
            window.speechSynthesis.speak(msg);

            // Passage à la mesure suivante après 1.5 seconde
            setTimeout(() => {
                display.style.color = "white";
                if (idx < mesures.length - 1) {
                    idx++;
                    label.innerText = mesures[idx];
                    display.innerText = "--";
                } else {
                    label.innerText = "FINI !";
                    state.innerText = "Toutes les mesures sont prises.";
                    recognition.stop();
                }
            }, 1500);
        }
    };

    recognition.onerror = (event) => {
        console.log("Erreur : " + event.error);
        if (event.error === 'no-speech') {
            // Relance silencieuse si aucun son détecté
            try { recognition.stop(); } catch(e){}
        }
    };

    recognition.onend = () => {
        // LA CLÉ : Si le micro se coupe tout seul, on le relance immédiatement
        // Cela évite les bips de fin de session
        led.classList.remove('recording');
        state.innerText = "Reconnexion...";
        setTimeout(() => {
            if (label.innerText !== "FINI !") recognition.start();
        }, 100);
    };

</script>
</body>
</html>
