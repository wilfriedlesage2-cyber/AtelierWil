<script>
    const mesures = [
        "Tour de poitrine", "Tour de taille", "Tour de hanches", "Tour de bassin", "Hauteur poitrine", 
        "Longueur devant", "Largeur devant", "Ecartement poitrine", "Encolure", "Longueur épaule",
        "Tour de bras", "Tour de coude", "Tour de poignet", "Longueur bras au coude", "Longueur bras total",
        "Largeur dos", "Longueur dos", "Hauteur sous bras", "Hauteur taille-hanches", "Hauteur taille-bassin",
        "Tour de cuisse", "Tour de genou", "Tour de mollet", "Tour de cheville", "Hauteur taille-genou",
        "Hauteur taille-sol", "Hauteur entrejambe-sol", "Montante", "Tour de tête", "Tour de main", "Stature totale"
    ];

    let idx = 0;
    let recognition;
    let attendConfirm = false;
    let tempVal = "";

    // FONCTION DE VOIX AVEC DÉVERROUILLAGE
    function parler(t, cb) {
        window.speechSynthesis.cancel(); // Stoppe toute voix en cours
        const u = new SpeechSynthesisUtterance(t);
        u.lang = 'fr-FR';
        u.rate = 1.1;
        if (cb) u.onend = cb;
        window.speechSynthesis.speak(u);
    }

    function demarrer() {
        console.log("Tentative de démarrage...");
        
        // 1. Débloquer la synthèse vocale (obligatoire sur Android)
        parler(""); 

        // 2. Basculer l'interface
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('ui').style.display = 'flex';
        
        // 3. Initialiser le micro
        try {
            initSpeech();
            setTimeout(annoncer, 500);
        } catch (e) {
            alert("Erreur micro : " + e.message);
        }
    }

    function initSpeech() {
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!Speech) {
            alert("Votre navigateur ne supporte pas la reconnaissance vocale. Utilisez Chrome.");
            return;
        }
        
        recognition = new Speech();
        recognition.lang = 'fr-FR';
        recognition.continuous = true;
        recognition.interimResults = false;

        recognition.onresult = (e) => {
            const text = e.results[e.results.length - 1][0].transcript.toLowerCase();
            if (attendConfirm) {
                if (text.includes("oui") || text.includes("valide") || text.includes("ok")) {
                    valider(true);
                } else if (text.includes("non") || text.includes("recommence") || text.includes("erreur")) {
                    valider(false);
                }
            } else {
                let num = text.replace(/[^0-9,.]/g, '').replace(',', '.');
                const match = num.match(/\d+(\.\d+)?/);
                if (match) {
                    tempVal = match[0];
                    demanderConfirmation(tempVal);
                }
            }
        };

        recognition.onstart = () => {
            document.getElementById('led').className = "led on";
            console.log("Micro activé");
        };

        recognition.onerror = (e) => {
            console.error("Erreur recognition:", e.error);
            if(e.error === 'not-allowed') alert("Activez l'autorisation Micro dans les paramètres de Chrome");
        };

        recognition.onend = () => {
            if (idx < mesures.length) recognition.start();
        };

        recognition.start();
    }

    function annoncer() {
        attendConfirm = false;
        document.getElementById('label').innerText = mesures[idx];
        document.getElementById('display').innerText = "--";
        document.getElementById('display').style.color = "white";
        document.getElementById('status').innerText = "ÉCOUTE...";
        document.getElementById('progress').innerText = `${idx + 1} / 31`;
        parler(mesures[idx]);
    }

    function demanderConfirmation(v) {
        attendConfirm = true;
        const affichage = v.replace('.', ',');
        document.getElementById('display').innerText = affichage;
        document.getElementById('status').innerText = "VALIDER ?";
        parler(affichage + ". Valider ?");
    }

    function valider(ok) {
        if (ok) {
            document.getElementById('display').style.color = "#2ecc71";
            idx++;
            if (idx < mesures.length) {
                setTimeout(annoncer, 400);
            } else {
                document.getElementById('label').innerText = "FINI";
                parler("Terminé.");
            }
        } else {
            document.getElementById('display').style.color = "#ff4444";
            setTimeout(annoncer, 400);
        }
    }
</script>
