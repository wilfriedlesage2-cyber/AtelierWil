<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Atelier Wil - Précision</title>
    <style>
        :root { --accent: #d4af37; --dark: #0a0a0a; --green: #2ecc71; }
        body { font-family: sans-serif; background: var(--dark); color: white; text-align: center; margin: 0; overflow: hidden; }
        .container { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .mesure-nom { font-size: 28px; color: var(--accent); text-transform: uppercase; margin-bottom: 10px; height: 40px; }
        .valeur { font-size: 120px; font-weight: bold; margin: 20px 0; min-height: 140px; }
        .status-pill { padding: 8px 20px; border-radius: 20px; font-size: 14px; letter-spacing: 2px; background: #222; color: #666; }
        .listening { background: var(--green); color: black; box-shadow: 0 0 15px var(--green); }
        .btn-start { padding: 25px 50px; background: var(--accent); border: none; border-radius: 50px; font-weight: bold; font-size: 20px; cursor: pointer; }
    </style>
</head>
<body>

<div id="start-screen" class="container">
    <h1 style="color:var(--accent); letter-spacing:5px;">ATELIER WIL</h1>
    <button class="btn-start" onclick="demarrer()">DÉMARRER L'ASSISTANT</button>
</div>

<div id="ui" class="container" style="display:none;">
    <div id="progress" style="font-size: 16px; opacity: 0.5; margin-bottom: 20px;">1 / 31</div>
    <div id="label" class="mesure-nom">Prêt</div>
    <div id="display" class="valeur">--</div>
    <div id="status" class="status-pill">CHARGEMENT</div>
</div>

<script>
    const mesures = ["Tour de poitrine", "Tour de taille", "Tour de hanches", "Tour de bassin", "Hauteur poitrine", "Longueur devant", "Largeur devant", "Ecartement poitrine", "Encolure", "Longueur épaule", "Tour de bras", "Tour de coude", "Tour de poignet", "Longueur bras au coude", "Longueur bras total", "Largeur dos", "Longueur dos", "Hauteur sous bras", "Hauteur taille-hanches", "Hauteur taille-bassin", "Tour de cuisse", "Tour de genou", "Tour de mollet", "Tour de cheville", "Hauteur taille-genou", "Hauteur taille-sol", "Hauteur entrejambe-sol", "Montante", "Tour de tête", "Tour de main", "Stature totale"];
    let idx = 0;
    let recognition;
    let attendConfirm = false;
    let tempVal = "";

    function parler(texte, callback) {
        // On arrête l'écoute avant de parler pour éviter l'écho
        if (recognition) recognition.stop();
        
        const u = new SpeechSynthesisUtterance(texte);
        u.lang = 'fr-FR';
        u.rate = 1.1;
        
        u.onend = () => {
            // On relance l'écoute seulement quand elle a fini de parler
            if (recognition) recognition.start();
            if (callback) callback();
        };
        window.speechSynthesis.speak(u);
    }

    function demarrer() {
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('ui').style.display = 'flex';
        
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new Speech();
        recognition.lang = 'fr-FR';
        recognition.continuous = false; // Plus stable pour les réponses courtes
        recognition.interimResults = false;

        recognition.onstart = () => {
            document.getElementById('status').innerText = "À VOUS...";
            document.getElementById('status').classList.add('listening');
        };

        recognition.onend = () => {
            document.getElementById('status').innerText = "PAUSE";
            document.getElementById('status').classList.remove('listening');
        };

        recognition.onresult = (e) => {
            const result = e.results[0][0].transcript.toLowerCase();
            console.log("Reçu:", result);

            if (attendConfirm) {
                if (result.includes("oui") || result.includes("ok") || result.includes("valide")) {
                    valider(true);
                } else if (result.includes("non") || result.includes("erreur")) {
                    valider(false);
                } else {
                    // Si elle n'a pas compris oui/non, elle redemande
                    parler(tempVal + ". Valider ?");
                }
            } else {
                let num = result.replace(/[^0-9,.]/g, '').replace(',', '.');
                const match = num.match(/\d+(\.\d+)?/);
                if (match) {
                    tempVal = match[0];
                    attendConfirm = true;
                    document.getElementById('display').innerText = tempVal.replace('.', ',');
                    parler(tempVal.replace('.', ',') + ". Valider ?");
                } else {
                    // Si pas de chiffre entendu, on relance l'écoute
                    recognition.start();
                }
            }
        };

        annoncer();
    }

    function annoncer() {
        attendConfirm = false;
        document.getElementById('label').innerText = mesures[idx];
        document.getElementById('display').innerText = "--";
        document.getElementById('display').style.color = "white";
        document.getElementById('progress').innerText = `${idx + 1} / ${mesures.length}`;
        parler(mesures[idx]);
    }

    function valider(ok) {
        if (ok) {
            document.getElementById('display').style.color = "#2ecc71";
            idx++;
            if (idx < mesures.length) {
                setTimeout(annoncer, 400);
            } else {
                document.getElementById('label').innerText = "FIN";
                parler("Mesures terminées.");
            }
        } else {
            document.getElementById('display').style.color = "#ff4444";
            setTimeout(annoncer, 400);
        }
    }
</script>
</body>
</html>
