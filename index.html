<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Atelier Wil - Expert v2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --accent: #d4af37; --dark: #0f0f0f; --card: #1a1a1a; --text: #e0e0e0; --red: #ff4444; --green: #2ecc71; }
        body { font-family: sans-serif; background: var(--dark); color: var(--text); margin: 0; padding: 0; }
        .page { display: none; min-height: 100vh; padding: 20px; flex-direction: column; }
        .active { display: flex; }
        .btn { width: 100%; max-width: 400px; padding: 18px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; text-transform: uppercase; margin: 8px auto; display: block; }
        .btn-gold { background: var(--accent); color: black; }
        .btn-mic { background: #333; color: white; border: 2px solid #444; }
        .btn-mic.active-mic { border-color: var(--green); color: var(--green); box-shadow: 0 0 15px var(--green); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        input { width: 100%; padding: 15px; background: #222; border: 1px solid #333; color: white; border-radius: 8px; margin-bottom: 12px; box-sizing: border-box; font-size: 22px; text-align: center; }
        .m-card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #333; }
        .m-card.active-voice { border: 2px solid var(--green); background: rgba(46, 204, 113, 0.1); }
        .v-status { text-align: center; color: var(--accent); font-weight: bold; height: 30px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="p1" class="page active">
        <h1 style="color:var(--accent); letter-spacing:5px;">ATELIER WIL</h1>
        <button onclick="allerA(2)" class="btn btn-gold">DÃ‰MARRER MESURES</button>
    </div>

    <div id="p2" class="page">
        <button id="btn-vocal" class="btn btn-mic" onclick="toggleVoice()">ðŸŽ¤ ACTIVER LE MICRO</button>
        <div id="v-status" class="v-status">Micro en attente...</div>
        <div id="m-target"></div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn btn-gold" onclick="nextG()">SUIVANT</button>
        </div>
    </div>

<script>
    const mesures = ["Tour de poitrine", "Tour de taille", "Tour de hanches", "Tour de bassin", "Long. devant", "Carrure devant", "Encolure", "Carrure dos", "Long. dos", "Bras", "Poignet"];
    let dataStore = {};
    let currentG = 0;
    let voiceIndex = 0;
    let isVoiceActive = false;
    let recognition;

    function allerA(n) { 
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('p'+n).classList.add('active');
        if(n === 2) renderM();
    }

    function renderM() {
        const target = document.getElementById('m-target');
        const start = currentG * 3;
        let html = '';
        for(let i=start; i<start+3 && i<mesures.length; i++) {
            const isV = (isVoiceActive && i === voiceIndex) ? 'active-voice' : '';
            html += `<div class="m-card ${isV}"><label>${mesures[i]}</label>
            <input type="number" id="input-${i}" value="${dataStore[i] || ''}" oninput="dataStore[${i}]=this.value"></div>`;
        }
        target.innerHTML = html;
    }

    function nextG() { if(currentG < Math.ceil(mesures.length/3)-1) { currentG++; renderM(); } }

    function toggleVoice() {
        if(!isVoiceActive) {
            isVoiceActive = true;
            document.getElementById('btn-vocal').classList.add('active-mic');
            voiceIndex = currentG * 3;
            startRec();
        } else {
            stopRec();
        }
    }

    function stopRec() {
        isVoiceActive = false;
        if(recognition) recognition.stop();
        document.getElementById('btn-vocal').classList.remove('active-mic');
        document.getElementById('v-status').innerText = "Micro Ã©teint";
    }

    function startRec() {
        if(!isVoiceActive) return;
        
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new Speech();
        recognition.lang = 'fr-FR';
        recognition.continuous = false; // Important pour Ã©viter les bips de saturation
        recognition.interimResults = false;

        document.getElementById('v-status').innerText = "Ã‰COUTE : " + mesures[voiceIndex];

        recognition.onresult = (e) => {
            let res = e.results[0][0].transcript;
            let val = res.replace(/[^0-9]/g, ""); // On ne garde que les chiffres
            
            if(val) {
                dataStore[voiceIndex] = val;
                renderM();
                voiceIndex++;
                
                // Si on a fini le groupe de 3, on passe au suivant
                if(voiceIndex % 3 === 0 && voiceIndex < mesures.length) {
                    currentG++;
                    renderM();
                }
                
                if(voiceIndex < mesures.length) {
                    setTimeout(startRec, 300); // Relance propre pour la mesure suivante
                } else {
                    stopRec();
                    alert("Toutes les mesures sont capturÃ©es !");
                }
            }
        };

        recognition.onerror = (e) => {
            console.log("Erreur micro:", e.error);
            if(isVoiceActive) setTimeout(startRec, 500); // Relance automatique en cas de bug
        };

        recognition.start();
    }
</script>
</body>
</html>
